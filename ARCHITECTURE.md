# Краткий план реализации проекта GophKeeper

## Архитектура проекта

Проект представляет собой клиент-серверную систему, предназначенную для безопасного хранения и синхронизации приватных данных пользователя.

- Клиент — приложение командной строки (CLI), совместимое с операционными системами Linux, Windows, Mac OS.
- Сервер — выполняет функцию облачного хранилища и обеспечивает синхронизацию данных между клиентами.

## Формат и хранение данных

Используется единый зашифрованный файл-база формата KDBX (аналогично KeePass). Формат KDBX был разработан для проекта KeePass Password Safe и стал стандартом де-факто для безопасного хранения паролей. [Документация по формату KDBX](https://keepass.info/help/kb/kdbx_4.html), [Страница в Wikipedia](https://en.wikipedia.org/wiki/KeePass).

### Работа клиента с базой KDBX

- Клиент предоставляет полнофункциональный TUI-интерфейс для работы с KDBX-файлами, который позволяет:
  - Создавать новые базы данных и задавать мастер-пароль
  - Просматривать, создавать, редактировать и удалять записи различных типов
  - Осуществлять поиск по базе данных
- Библиотека [gokeepasslib](https://github.com/tobischo/gokeepasslib) используется для работы с KDBX файлами:
  - Шифрование/дешифрование баз данных
  - Чтение и запись в формате KDBX версии 3.1 и 4.0
  - Управление структурой данных (записи, вложения)

Типы хранимых данных:

- Логины и пароли
- Данные банковских карт
- SSH-ключи и другие бинарные данные (в виде вложений)
- Произвольные текстовые данные и дополнительная метаинформация

## Регистрация и аутентификация пользователей

Процесс делится на две части:

- Серверная авторизация: пользователь регистрируется и авторизуется на сервере, используя логин и пароль. Сервер выдаёт токен авторизации.
- Клиентская расшифровка данных: на клиенте пользователь вводит отдельный мастер-пароль для локального шифрования и расшифровки файла-базы. Этот пароль никогда не передаётся на сервер.

## Безопасность

- База данных шифруется алгоритмом AES-256.
- Авторизация пользователей на сервере осуществляется через JWT-токены.
- Передача данных осуществляется через защищённый канал HTTPS/TLS.
- Сервер не имеет доступа к расшифрованным данным.

## Синхронизация и оффлайн-работа

- Клиент хранит данные локально в файле KDBX.
- При наличии подключения к сети выполняется синхронизация файла с сервером.
- Сервер хранит несколько последних версий файлов-баз для возможности восстановления данных.

## Разрешение конфликтов

- Используется подход «последнее изменение побеждает» (Last Write Wins) на уровне всего файла базы данных.
- В случае обнаружения конфликтов клиент предлагает пользователю ручное разрешение или автоматически объединяет изменения, если это возможно.

### Механизм определения конфликтов

- Сервер хранит только зашифрованные файлы баз данных и метаданные о них (время последнего обновления, размер, хэш файла).
- Сервер не имеет доступа к содержимому базы и не может определять конфликты на уровне отдельных записей.
- Клиент обрабатывает конфликты в следующем порядке:
  1. При синхронизации клиент запрашивает метаданные о файле (время последнего обновления, хэш) с сервера.
  2. Клиент сравнивает метаданные локального файла с серверным.
  3. При обнаружении различий скачивает серверную версию.
  4. Расшифровывает обе версии (локальную и серверную) и анализирует изменения локально.
  5. Выявляет конфликтующие записи по их UUID, меткам времени и хэшам содержимого.

### Важное уточнение о синхронизации

- **Односторонние изменения** — если изменения были внесены только в локальную версию базы, а серверная версия не менялась с момента последней синхронизации:
  - Это не считается конфликтом
  - Локальная версия просто загружается на сервер, заменяя предыдущую версию
  - Алгоритм разрешения конфликтов не запускается

- **Двусторонние изменения** — если и локальная, и серверная версии изменились независимо (например, с разных устройств):
  - Запускается полноценный механизм разрешения конфликтов
  - Клиент анализирует различия и предлагает решения согласно описанным кейсам

### Локальный доступ к базе из нескольких клиентов

- **Блокировка файла** — используются системные механизмы блокировки (flock/fcntl в UNIX/macOS, LockFileEx в Windows) через пакет [github.com/gofrs/flock](https://github.com/gofrs/flock)
- **Режим "только чтение"** — если файл уже заблокирован другим процессом
- **Автоматическое восстановление** — проверка целостности базы данных при открытии

### Основные кейсы конфликтов

1. **Конфликт версий файла** — когда локальная и серверная версии базы отличаются:
   - Автоматическое разрешение: если изменения не пересекаются, клиент объединяет их.
   - Ручное разрешение: пользователю предлагается выбрать между версиями или провести ручное объединение.

2. **Одновременное редактирование одной записи** — когда два клиента изменили одну и ту же запись:
   - Автоматическое разрешение: применяется изменение с более поздней меткой времени.
   - Ручное разрешение: пользователю показываются обе версии и предлагается выбрать нужную.

3. **Удаление и редактирование** — когда один клиент удалил запись, а другой её отредактировал:
   - Автоматическое разрешение: приоритет у более поздней операции.
   - Ручное разрешение: пользователь решает, восстановить ли удалённую запись с изменениями.

4. **Создание записей с одинаковым содержимым** — потенциальные дубликаты:
   - Автоматическое определение: по совпадению ключевых полей.
   - Ручное разрешение: пользователь решает, объединить записи или оставить обе.

### Обработка конфликтов в офлайн-режиме

- Локальные изменения сохраняются с метками времени.
- При восстановлении подключения выполняется алгоритм сравнения и объединения версий.
- Если обнаружены критические конфликты, пользователю предлагается выбрать стратегию синхронизации.

## Инструменты реализации

- Библиотека для работы с KeePass-файлами: [gokeepasslib](https://github.com/tobischo/gokeepasslib)

## Тестирование и документация

- Покрытие кода unit-тестами не менее 80%.
- Документация для всех экспортируемых функций и пакетов.
- Документация API взаимодействия клиента и сервера.

## Дополнительно

- Реализация удобного терминального интерфейса (TUI) с использованием библиотеки [Bubble Tea](https://github.com/charmbracelet/bubbletea):
- Описание API в формате Swagger.
- Интеграционные тесты клиент-серверного взаимодействия (по возможности).
