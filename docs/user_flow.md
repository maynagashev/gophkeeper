# Пользовательский сценарий GophKeeper (Клиент)

Этот документ описывает планируемый процесс взаимодействия пользователя с TUI-клиентом GophKeeper, включая интеграцию с серверной частью для синхронизации.

## 1. Запуск приложения

1. Приложение запускается с указанием пути к файлу `.kdbx`.
2. Проверяется наличие файла:
    * **Файл существует:** Пользователю предлагается ввести мастер-пароль.
    * **Файл НЕ существует:** Пользователю предлагается создать новый файл, задав для него мастер-пароль (требуется подтверждение).
3. **Блокировка файла (`flock`):**
    * Приложение пытается установить эксклюзивную блокировку файла (`.kdbx.lock`).
    * **Блокировка получена:** Приложение работает в стандартном режиме (чтение/запись).
    * **Блокировка НЕ получена:** Приложение переходит в режим "Только для чтения" (Read-Only), уведомляя пользователя.
4. **Проверка конфигурации синхронизации:**
    * После успешного открытия KDBX файла (ввода/создания пароля), приложение проверяет наличие сохраненных данных для подключения к серверу (URL, токен) внутри KDBX (например, в специальной группе).
    * **Данные найдены:** Приложение может попытаться проверить валидность токена (например, фоновым запросом метаданных).
    * **Данные не найдены:** Функции синхронизации будут неактивны до настройки.

## 2. Основной экран: Список записей

Это главный экран после успешного входа/создания KDBX.

* **Навигация:** `↑`/`↓` для перемещения по списку.
* **Фильтрация/Поиск:** `/` для активации строки поиска.
* **Просмотр деталей:** `Enter` на выбранной записи.
* **Добавление записи:** `a`.
* **Сохранение изменений:** `Ctrl+S` (если не Read-Only).
* **Выход:** `q` или `Ctrl+C`.
* **Новое: Вход/Регистрация:** `l` - запускает процесс входа или регистрации на сервере (см. раздел 5).
* **Новое: Меню Синхронизации:** `s` - открывает экран "Синхронизация и Сервер" (см. раздел 3).

## 3. Экран "Синхронизация и Сервер" (вызывается по `s`)

Этот экран предоставляет информацию и действия, связанные с сервером.

* **Отображаемая информация:**
  * URL сервера: (Текущий настроенный URL или "Не настроен")
  * Статус входа: ("Вход выполнен как [имя_пользователя]" или "Не выполнен")
  * Статус синхронизации: (Время последней синхронизации, результат или "Не синхронизировалось")
* **Доступные действия (навигация `↑`/`↓`, выбор `Enter`):**
  * **Настроить сервер / Изменить URL:** Запрашивает ввод URL сервера. После ввода переходит к процессу входа/регистрации.
  * **Войти / Зарегистрироваться:** Переходит к процессу входа/регистрации (см. раздел 5).
  * **Синхронизировать сейчас:** Запускает процесс синхронизации (сравнение метаданных, загрузка/скачивание).
  * **Выйти:** Удаляет сохраненный токен, выходит из учетной записи на сервере.
  * **Просмотреть версии (TODO):** Позволит просмотреть историю версий на сервере.
  * **Назад:** `Esc` или `b` - возврат к списку записей.

## 4. Просмотр и Редактирование Записей

Логика остается прежней, как в локальной версии:

* **Просмотр (`Enter` из списка):** Отображение полей записи. Доступны действия:
  * `e`: Переход в режим редактирования.
  * `Esc`/`b`: Назад к списку.
* **Редактирование (`e` из просмотра) / Добавление (`a` из списка):**
  * Навигация по полям: `Tab`, `Shift+Tab`, `↑`/`↓`.
  * Сохранение изменений/Добавление записи: `Enter`.
  * Отмена: `Esc`.
  * Работа с вложениями (Добавить `Ctrl+O`, Удалить `Ctrl+D` - может быть изменено).

## 5. Процесс Входа / Регистрации (вызывается по `l` или из меню `s`)

1. **Проверка URL:** Если URL сервера не сохранен, сначала запрашивается его ввод.
2. **Выбор действия:** Пользователю предлагается выбор: "(Р)егистрация нового пользователя или (В)ход?"
3. **Ввод данных:** Запрашивается Имя пользователя и Пароль (ввод пароля маскируется).
4. **Вызов API:** Выполняется HTTP-запрос к серверу (`/api/register` или `/api/login`).
5. **Обработка результата:**
    * **Успех:**
        * Сообщение об успешном входе/регистрации.
        * URL сервера и полученный JWT токен сохраняются внутри KDBX файла.
        * Пользователь возвращается на предыдущий экран (список записей или меню синхронизации).
    * **Ошибка (неверные данные, ошибка сети и т.д.):**
        * Отображается сообщение об ошибке.
        * Пользователь остается на экране входа/регистрации для повторной попытки.
    * **Отмена:** `Esc` - возврат на предыдущий экран без сохранения.

## 6. Синхронизация (вызывается из меню `s`)

* **Условие:** Пользователь должен быть аутентифицирован (токен сохранен и валиден).
* **Процесс (упрощенно - Last Write Wins):**
    1. Клиент запрашивает метаданные текущей версии хранилища с сервера.
    2. Сервер запрашивает метаданные локальной версии (или клиент их отправляет).
    3. Сравниваются версии (например, по времени изменения или хешу).
    4. **Если версии расходятся:**
        * Определяется, чья версия новее (Last Write Wins).
        * **Сервер новее:** Клиент скачивает версию с сервера, перезаписывая локальную (с созданием бэкапа?).
        * **Клиент новее:** Клиент загружает свою версию на сервер.
    5. **Если версии совпадают:** Синхронизация не требуется.
* **Обратная связь:** Отображается статус процесса и результат (успех/ошибка).

## 7. Обработка ошибок и крайние случаи

* **Невалидный/истекший токен:** При попытке выполнить действие, требующее аутентификации (синхронизация, просмотр версий), если токен невалиден, пользователю предлагается повторно войти через экран входа (`l`).
* **Сетевые ошибки:** При ошибках сети во время запросов к API, отображается соответствующее сообщение.
* **Конфликты синхронизации (базовые):** Пока используется стратегия "Last Write Wins". В будущем можно рассмотреть ручное разрешение конфликтов.
* **Режим Read-Only:** Все операции записи (сохранение KDBX, загрузка на сервер, регистрация/логин с сохранением токена) блокируются.
